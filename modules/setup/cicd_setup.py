"""CICD ÌôòÍ≤Ω ÏÑ§Ï†ï Î™®Îìà"""

import logging
import os
import json
import subprocess
from typing import Dict, Optional, Any, List
from googleapiclient.discovery import build
from google.oauth2 import service_account

from ..config import Config
from ..auth import get_credentials

logger = logging.getLogger(__name__)

class CICDSetupManager:
    """CICD ÌôòÍ≤Ω ÏÑ§Ï†ï Í¥ÄÎ¶¨Ïûê"""
    
    def __init__(self):
        self.credentials = None
        self.project_id = None
        self.cloudbuild_service = None
        self.artifactregistry_service = None
        
        
    def initialize(self) -> bool:
        """CICD ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî"""
        try:
            # Î®ºÏ†Ä Ïù∏Ï¶ù Ï¥àÍ∏∞Ìôî
            from ..auth import initialize_auth
            if not initialize_auth():
                logger.error("‚ùå GCP Ïù∏Ï¶ù Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§")
                return False
                
            self.credentials = get_credentials()
            if not self.credentials:
                logger.error("‚ùå GCP Ïù∏Ï¶ù Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§")
                return False
                
            self.project_id = Config.PROJECT_ID
            if not self.project_id:
                logger.error("‚ùå PROJECT_ID ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§")
                return False
                
            # ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
            self.cloudbuild_service = build('cloudbuild', 'v1', credentials=self.credentials)
            
            logger.info(f"‚úÖ CICD ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å - Project: {self.project_id}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå CICD ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî Ïã§Ìå®: {e}")
            return False
    
    def create_artifact_repository(self, 
                                 repo_name: str = "graphrag-repo",
                                 location: str = "asia-northeast3") -> bool:
        """Artifact Registry Ï†ÄÏû•ÏÜå ÏÉùÏÑ±"""
        try:
            # Artifact Registry API ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏
            from google.cloud import artifactregistry_v1
            
            client = artifactregistry_v1.ArtifactRegistryClient(credentials=self.credentials)
            
            # Ï†ÄÏû•ÏÜå Ï°¥Ïû¨ ÌôïÏù∏
            repository_name = f"projects/{self.project_id}/locations/{location}/repositories/{repo_name}"
            try:
                repository = client.get_repository(name=repository_name)
                logger.info(f"‚úÖ Artifact Registry Ï†ÄÏû•ÏÜå '{repo_name}' Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï®")
                return True
            except Exception:
                pass  # Ï†ÄÏû•ÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
            
            # Ï†ÄÏû•ÏÜå ÏÉùÏÑ±
            logger.info(f"üîÑ Artifact Registry Ï†ÄÏû•ÏÜå '{repo_name}' ÏÉùÏÑ± Ï§ë...")
            
            parent = f"projects/{self.project_id}/locations/{location}"
            repository = artifactregistry_v1.Repository(
                name=repository_name,
                format_=artifactregistry_v1.Repository.Format.DOCKER,
                description=f"GraphRAG ÌîÑÎ°úÏ†ùÌä∏ Docker Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•ÏÜå"
            )
            
            operation = client.create_repository(
                parent=parent,
                repository=repository,
                repository_id=repo_name
            )
            
            # Operation Ïù¥Î¶Ñ ÏïàÏ†ÑÌïòÍ≤å Í∞ÄÏ†∏Ïò§Í∏∞
            operation_name = getattr(operation, 'name', str(operation))
            logger.info(f"üîÑ Ï†ÄÏû•ÏÜå ÏÉùÏÑ± Ï§ë... (Operation: {operation_name})")
            
            # ÏÉùÏÑ± ÏôÑÎ£å ÎåÄÍ∏∞
            import time
            for i in range(30):  # ÏµúÎåÄ 5Î∂Ñ ÎåÄÍ∏∞
                time.sleep(10)
                try:
                    repository = client.get_repository(name=repository_name)
                    logger.info(f"‚úÖ Artifact Registry Ï†ÄÏû•ÏÜå ÏÉùÏÑ± ÏôÑÎ£å: {repo_name}")
                    return True
                except Exception:
                    if i % 6 == 0:  # 1Î∂ÑÎßàÎã§ Î°úÍ∑∏
                        logger.info(f"üîÑ Ï†ÄÏû•ÏÜå ÏÉùÏÑ± ÎåÄÍ∏∞ Ï§ë... ({i//6 + 1}/5Î∂Ñ)")
                    continue
            
            logger.warning(f"‚ö†Ô∏è Ï†ÄÏû•ÏÜå ÏÉùÏÑ± ÏãúÍ∞Ñ Ï¥àÍ≥º")
            return False
            

        except Exception as e:
            logger.error(f"‚ùå Artifact Registry Ï†ÄÏû•ÏÜå ÏÉùÏÑ± Ïã§Ìå®: {e}")
            return False
    
    def setup_cloud_build_trigger(self,
                                trigger_name: str = "graphrag-deploy-trigger",
                                repo_owner: str = None,
                                repo_name: str = None,
                                branch_pattern: str = "^main$") -> bool:
        """Cloud Build Ìä∏Î¶¨Í±∞ ÏÑ§Ï†ï"""
        try:
            if not repo_owner or not repo_name:
                logger.warning("‚ö†Ô∏è GitHub Ï†ÄÏû•ÏÜå Ï†ïÎ≥¥Í∞Ä ÏóÜÏñ¥ Ìä∏Î¶¨Í±∞ ÏÉùÏÑ±ÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§")
                logger.info("üí° ÏàòÎèôÏúºÎ°ú Cloud Build Ìä∏Î¶¨Í±∞Î•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî")
                return True
            
            # Í∏∞Ï°¥ Ìä∏Î¶¨Í±∞ ÌôïÏù∏
            triggers = self.cloudbuild_service.projects().triggers().list(
                projectId=self.project_id
            ).execute()
            
            for trigger in triggers.get('triggers', []):
                if trigger.get('name') == trigger_name:
                    logger.info(f"‚úÖ Cloud Build Ìä∏Î¶¨Í±∞ '{trigger_name}' Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï®")
                    return True
            
            # Ìä∏Î¶¨Í±∞ ÏÉùÏÑ±
            logger.info(f"üîÑ Cloud Build Ìä∏Î¶¨Í±∞ '{trigger_name}' ÏÉùÏÑ± Ï§ë...")
            
            trigger_config = {
                'name': trigger_name,
                'description': 'GraphRAG ÌîÑÎ°úÏ†ùÌä∏ ÏûêÎèô Î∞∞Ìè¨ Ìä∏Î¶¨Í±∞',
                'github': {
                    'owner': repo_owner,
                    'name': repo_name,
                    'push': {
                        'branch': branch_pattern
                    }
                },
                'filename': 'cloudbuild.yaml',
                'substitutions': {
                    '_PROJECT_ID': self.project_id,
                    '_REGION': Config.LOCATION_ID or 'asia-northeast3',
                    '_SERVICE_NAME': f'{self.project_id}-graphrag-api',
                    '_REPO_NAME': f'{self.project_id}-graphrag-repo'
                }
            }
            
            operation = self.cloudbuild_service.projects().triggers().create(
                projectId=self.project_id,
                body=trigger_config
            ).execute()
            
            logger.info(f"‚úÖ Cloud Build Ìä∏Î¶¨Í±∞ ÏÉùÏÑ± ÏôÑÎ£å: {trigger_name}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Cloud Build Ìä∏Î¶¨Í±∞ ÏÑ§Ï†ï Ïã§Ìå®: {e}")
            return False
    
    def generate_cloudbuild_config(self) -> bool:
        """cloudbuild.yaml ÏÑ§Ï†ï ÌååÏùº ÏÉùÏÑ±"""
        try:
            template_path = "cloudbuild.yaml.template"
            target_path = "cloudbuild.yaml"

            logger.info(f"üîÑ ÌÖúÌîåÎ¶ø ÌååÏùº({template_path})ÏùÑ ÏùΩÏñ¥ {target_path} ÌååÏùºÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§...")

            if not os.path.exists(template_path):
                logger.error(f"‚ùå ÌÖúÌîåÎ¶ø ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§: {template_path}")
                return False

            with open(template_path, 'r', encoding='utf-8') as f:
                content = f.read()

            # .env ÌååÏùºÏóêÏÑú ÏÑ§Ï†ïÍ∞í Í∞ÄÏ†∏Ïò§Í∏∞
            project_id = Config.PROJECT_ID
            region = Config.LOCATION_ID or 'asia-northeast3'
            location_id = Config.LOCATION_ID or 'asia-northeast3'
            service_name = f"{project_id}-graphrag-api"
            repo_name = f"{project_id}-graphrag-repo"
            service_account = Config.SERVICE_ACCOUNT_EMAIL or f"graphrag-service@{project_id}.iam.gserviceaccount.com"
            datastore_id = Config.DATASTORE_ID or f"{project_id}-graphrag-datastore"
            discovery_engine_id = Config.DISCOVERY_ENGINE_ID or f"{project_id}-graphrag-engine"
            datastore_location = Config.DISCOVERY_LOCATION or 'global'
            discovery_location = Config.DISCOVERY_LOCATION or 'global'

            replacements = {
                '_PROJECT_ID_': project_id,
                '_REGION_': region,
                '_LOCATION_ID_': location_id,
                '_SERVICE_NAME_': service_name,
                '_REPO_NAME_': repo_name,
                '_SERVICE_ACCOUNT_': service_account,
                '_DATASTORE_ID_': datastore_id,
                '_DISCOVERY_ENGINE_ID_': discovery_engine_id,
                '_DATASTORE_LOCATION_': datastore_location,
                '_DISCOVERY_LOCATION_': discovery_location,
            }

            for placeholder, value in replacements.items():
                content = content.replace(placeholder, value)

            with open(target_path, 'w', encoding='utf-8') as f:
                f.write(content)

            logger.info(f"‚úÖ {target_path} ÌååÏùº ÏÉùÏÑ±Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.")
            return True

        except Exception as e:
            logger.error(f"‚ùå cloudbuild.yaml ÏÉùÏÑ± Ïã§Ìå®: {e}")
            return False
    
    def _generate_default_cloudbuild_config(self) -> Dict[str, Any]:
        """Í∏∞Î≥∏ Cloud Build ÏÑ§Ï†ï ÏÉùÏÑ±"""
        # ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ Í≥†Ïú†Ìïú Ïù¥Î¶Ñ ÏÉùÏÑ±
        repo_name = f"{self.project_id}-graphrag-repo"
        service_name = f"{self.project_id}-graphrag-api"
        
        return {
            'substitutions': {
                '_PROJECT_ID': self.project_id,
                '_REGION': Config.LOCATION_ID or 'asia-northeast3',
                '_REPO_NAME': repo_name,
                '_SERVICE_NAME': service_name,
                '_SERVICE_ACCOUNT': Config.SERVICE_ACCOUNT_EMAIL or f"graphrag-service@{self.project_id}.iam.gserviceaccount.com",
                '_ARTIFACT_REGISTRY': f"{Config.LOCATION_ID or 'asia-northeast3'}-docker.pkg.dev",
                '_MIN_INSTANCES': '0',
                '_MAX_INSTANCES': '10',
                '_CPU': '1',
                '_MEMORY': '2Gi',
                '_TIMEOUT': '300s',
                '_DATASTORE_ID': Config.DATASTORE_ID or f"{self.project_id}-graphrag-datastore",
                '_DISCOVERY_ENGINE_ID': Config.DISCOVERY_ENGINE_ID or f"{self.project_id}-graphrag-engine",
                '_MODEL_ID': 'gemini-pro',
                '_LOCATION_ID': Config.LOCATION_ID or 'asia-northeast3',
                '_DATASTORE_LOCATION': Config.DISCOVERY_LOCATION or 'global'
            },
            'steps': [
                {
                    'name': 'gcr.io/cloud-builders/docker',
                    'args': [
                        'build',
                        '-t', '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}',
                        '-t', '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest',
                        '.'
                    ],
                    'id': 'build-image'
                },
                {
                    'name': 'gcr.io/cloud-builders/docker',
                    'args': [
                        'push',
                        '--all-tags',
                        '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}'
                    ],
                    'id': 'push-image',
                    'waitFor': ['build-image']
                },
                {
                    'name': 'gcr.io/google.com/cloudsdktool/cloud-sdk',
                    'entrypoint': 'gcloud',
                    'args': [
                        'run', 'deploy', '${_SERVICE_NAME}',
                        '--image=${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}',
                        '--region=${_REGION}',
                        '--platform=managed',
                        '--allow-unauthenticated',
                        '--service-account=${_SERVICE_ACCOUNT}',
                        '--min-instances=${_MIN_INSTANCES}',
                        '--max-instances=${_MAX_INSTANCES}',
                        '--cpu=${_CPU}',
                        '--memory=${_MEMORY}',
                        '--timeout=${_TIMEOUT}',
                        '--set-env-vars=PROJECT_ID=${_PROJECT_ID},LOCATION_ID=${_LOCATION_ID},MODEL_ID=${_MODEL_ID},DATASTORE_ID=${_DATASTORE_ID},DATASTORE_LOCATION=${_DATASTORE_LOCATION},DISCOVERY_ENGINE_ID=${_DISCOVERY_ENGINE_ID},DISCOVERY_LOCATION=${_DATASTORE_LOCATION},DISCOVERY_COLLECTION=default_collection,DISCOVERY_SERVING_CONFIG=default_config,SYSTEM_PROMPT_PATH=prompt/prompt.txt,USE_SECRET_MANAGER=True,SERVE_STATIC=false'
                    ],
                    'id': 'deploy-service',
                    'waitFor': ['push-image']
                }
            ],
            'options': {
                'logging': 'CLOUD_LOGGING_ONLY',
                'machineType': 'E2_HIGHCPU_4'
            },
            'serviceAccount': 'projects/${_PROJECT_ID}/serviceAccounts/${_SERVICE_ACCOUNT}',
            'images': [
                '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:${SHORT_SHA}',
                '${_ARTIFACT_REGISTRY}/${_PROJECT_ID}/${_REPO_NAME}/${_SERVICE_NAME}:latest'
            ]
        }
    
    def validate_cicd_setup(self) -> Dict[str, bool]:
        """CICD ÏÑ§Ï†ï Í≤ÄÏ¶ù"""
        results = {}
        
        try:
            # Artifact Registry Ï†ÄÏû•ÏÜå ÌôïÏù∏
            try:
                from google.cloud import artifactregistry_v1
                client = artifactregistry_v1.ArtifactRegistryClient(credentials=self.credentials)
                
                repo_name = f"projects/{self.project_id}/locations/{Config.LOCATION_ID or 'asia-northeast3'}/repositories/{self.project_id}-graphrag-repo"
                client.get_repository(name=repo_name)
                results['artifact_registry'] = True
            except Exception:
                results['artifact_registry'] = False
            
            # Cloud Build API ÌôúÏÑ±Ìôî ÌôïÏù∏
            try:
                self.cloudbuild_service.projects().builds().list(
                    projectId=self.project_id,
                    pageSize=1
                ).execute()
                results['cloudbuild_api'] = True
            except Exception:
                results['cloudbuild_api'] = False
            
            # cloudbuild.yaml ÌååÏùº ÌôïÏù∏
            results['cloudbuild_config'] = os.path.exists('cloudbuild.yaml')
            
            # Cloud Build Ìä∏Î¶¨Í±∞ ÌôïÏù∏ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
            try:
                triggers = self.cloudbuild_service.projects().triggers().list(
                    projectId=self.project_id
                ).execute()
                results['build_triggers'] = len(triggers.get('triggers', [])) > 0
            except Exception:
                results['build_triggers'] = False
            
            logger.info(f"‚úÖ CICD ÏÑ§Ï†ï Í≤ÄÏ¶ù ÏôÑÎ£å: {results}")
            return results
            
        except Exception as e:
            logger.error(f"‚ùå CICD ÏÑ§Ï†ï Í≤ÄÏ¶ù Ïã§Ìå®: {e}")
            return {}
    
    def print_cicd_setup_guide(self):
        """CICD ÏÑ§Ï†ï Í∞ÄÏù¥Îìú Ï∂úÎ†•"""
        logger.info("=" * 60)
        logger.info("üöÄ CICD ÌôòÍ≤Ω ÏÑ§Ï†ï Í∞ÄÏù¥Îìú")
        logger.info("=" * 60)
        
        logger.info("üìã ÏÉùÏÑ±Îêú CICD Î¶¨ÏÜåÏä§:")
        logger.info(f"  ‚Ä¢ Artifact Registry: {self.project_id}-graphrag-repo")
        logger.info(f"  ‚Ä¢ Service Account: graphrag-service@{self.project_id}.iam.gserviceaccount.com")
        logger.info(f"  ‚Ä¢ Cloud Build ÏÑ§Ï†ï: cloudbuild.yaml")
        
        logger.info("")
        logger.info("üîß ÏàòÎèô ÏÑ§Ï†ï ÌïÑÏöî:")
        logger.info("  1. GitHub Ï†ÄÏû•ÏÜå Ïó∞Í≤∞:")
        logger.info("     - Cloud Build > Ìä∏Î¶¨Í±∞ > Ï†ÄÏû•ÏÜå Ïó∞Í≤∞")
        logger.info("     - GitHub Ï†ÄÏû•ÏÜå ÏÑ†ÌÉù Î∞è Í∂åÌïú Î∂ÄÏó¨")
        
        logger.info("")
        logger.info("  2. Ìä∏Î¶¨Í±∞ ÏÉùÏÑ±:")
        logger.info("     - Ïù¥Î≤§Ìä∏: Push to branch")
        logger.info("     - ÏÜåÏä§: Ïó∞Í≤∞Îêú Ï†ÄÏû•ÏÜå")
        logger.info("     - Î∏åÎûúÏπò: ^main$")
        logger.info("     - Íµ¨ÏÑ±: Cloud Build Íµ¨ÏÑ± ÌååÏùº (yaml ÎòêÎäî json)")
        logger.info("     - ÌååÏùº ÏúÑÏπò: /cloudbuild.yaml")
        
        logger.info("")
        logger.info("  3. ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏:")
        logger.info("     - cloudbuild.yamlÏùò substitutions ÏÑπÏÖò")
        logger.info("     - ÌïÑÏöîÏãú ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ Í∞íÏúºÎ°ú ÏàòÏ†ï")
        
        logger.info("")
        logger.info("üöÄ Î∞∞Ìè¨ ÌÖåÏä§Ìä∏:")
        logger.info("  1. ÏΩîÎìúÎ•º main Î∏åÎûúÏπòÏóê Ìë∏Ïãú")
        logger.info("  2. Cloud Build > Í∏∞Î°ùÏóêÏÑú ÎπåÎìú ÏßÑÌñâ ÌôïÏù∏")
        logger.info("  3. Cloud Run > ÏÑúÎπÑÏä§ÏóêÏÑú Î∞∞Ìè¨ ÌôïÏù∏")
        
        logger.info("")
        logger.info("=" * 60)