# 2025-07-30 백엔드/프론트엔드 분리 배포 구성

GraphRAG 프로젝트의 백엔드와 프론트엔드를 분리하여 각각 다른 플랫폼에 배포하도록 구성한 변경사항을 정리합니다.

## 📋 작업 개요

기존의 풀스택 배포에서 **백엔드(Cloud Run)**와 **프론트엔드(Firebase Hosting)**를 분리하여 독립적으로 배포할 수 있도록 구성했습니다.

### 🎯 목표
- **백엔드**: Cloud Run에 API 서버만 배포
- **프론트엔드**: Firebase Hosting에 정적 파일만 배포
- **로컬 개발**: 기존과 동일하게 풀스택 개발 가능

## 📂 프로젝트 구조 분석

```
graphrag/
├── main.py                 # FastAPI 백엔드 메인 파일
├── modules/                # 백엔드 API 로직
├── prompt/                 # 백엔드 프롬프트 파일
├── requirements.txt        # Python 의존성
├── Dockerfile             # 백엔드 컨테이너 설정
├── cloudbuild.yaml        # 백엔드 Cloud Run 배포
├── public/                # 프론트엔드 정적 파일
│   ├── index.html
│   ├── style.css
│   └── vai.js
├── firebase.json          # Firebase Hosting 설정
└── .github/workflows/
    ├── deploy.yml         # 백엔드 배포 워크플로우
    └── firebase-hosting.yml # 프론트엔드 배포 워크플로우
```

## 🔧 주요 변경사항

### 1. Dockerfile 수정

**변경 전**:
```dockerfile
# 모든 파일 복사
COPY . .
```

**변경 후**:
```dockerfile
# 백엔드 파일만 선택적 복사
COPY main.py .
COPY modules/ ./modules/
COPY prompt/ ./prompt/
# public/ 폴더는 제외 (Firebase Hosting으로 분리)
```

### 2. main.py 환경별 분기 처리

**핵심 변경사항**:
```python
# 환경변수로 정적 파일 서빙 제어
import os
SERVE_STATIC = os.getenv("SERVE_STATIC", "true").lower() == "true"

if SERVE_STATIC:
    # 로컬 개발환경: 정적 파일 서빙
    @app.get("/")
    async def serve_root():
        return FileResponse("public/index.html")
    
    app.mount("/", StaticFiles(directory="public"), name="static")
else:
    # Cloud Run 배포환경: API만 제공
    @app.get("/")
    async def api_info():
        return {
            "service": "GraphRAG Chatbot API",
            "version": "2.0.0", 
            "status": "running",
            "frontend_url": "https://cheom-kdb-test1.web.app"
        }
```

### 3. Cloud Build 환경변수 추가

**cloudbuild.yaml** 수정:
```yaml
--set-env-vars=...,SERVE_STATIC=false
```

Cloud Run 배포시 정적 파일 서빙을 비활성화합니다.

### 4. GitHub Actions 워크플로우 분리

#### 백엔드 배포 (`deploy.yml`)
```yaml
name: Deploy Backend to Cloud Run

on:
  push:
    branches: [main, develop]
    paths:  # 백엔드 파일 변경시만 트리거
      - 'main.py'
      - 'modules/**'
      - 'prompt/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'cloudbuild.yaml'
```

#### 프론트엔드 배포 (`firebase-hosting.yml`)
```yaml
name: Firebase Hosting Deploy

on:
  push:
    branches: [main, develop]
    paths-ignore:  # 백엔드 파일 제외
      - 'main.py'
      - 'modules/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'cloudbuild.yaml'
```

### 5. Firebase Hosting 설정

**firebase.json**은 기존 설정을 유지:
```json
{
  "hosting": {
    "public": "public",
    "rewrites": [
      {
        "source": "/api/**",
        "run": {
          "serviceId": "testing0724",
          "region": "asia-northeast3"
        }
      },
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}
```

## 🚀 배포 플로우

### 백엔드 배포 (Cloud Run)

1. **트리거**: `main.py`, `modules/`, `prompt/`, `requirements.txt`, `Dockerfile`, `cloudbuild.yaml` 파일 변경
2. **과정**:
   - Docker 이미지 빌드 (백엔드 파일만 포함)
   - Artifact Registry에 푸시
   - Cloud Run에 배포 (`SERVE_STATIC=false`)
   - 헬스 체크 및 트래픽 전환

### 프론트엔드 배포 (Firebase Hosting)

1. **트리거**: `public/` 폴더 또는 `firebase.json` 파일 변경
2. **과정**:
   - 정적 파일 빌드/검증
   - Firebase Hosting에 배포
   - 환경별 채널 분리:
     - `develop` → staging 채널
     - `main` → live 채널

## 🎯 환경별 구성

### 로컬 개발 환경
```bash
# 풀스택 개발 가능 (기본값)
python main.py
# 또는
SERVE_STATIC=true python main.py
```
- 백엔드 API + 프론트엔드 정적 파일 모두 서빙
- `http://localhost:8000`에서 웹 화면 확인 가능

### 스테이징 환경 (develop 브랜치)
- **백엔드**: Cloud Run `testing0724` 서비스
- **프론트엔드**: `https://staging--cheom-kdb-test1.web.app`
- API 요청은 Firebase → Cloud Run으로 프록시

### 프로덕션 환경 (main 브랜치)
- **백엔드**: Cloud Run `graphrag-api` 서비스 (예정)
- **프론트엔드**: `https://cheom-kdb-test1.web.app`
- API 요청은 Firebase → Cloud Run으로 프록시

## 📊 배포 트리거 매트릭스

| 변경된 파일 | 백엔드 배포 | 프론트엔드 배포 |
|-------------|-------------|-----------------|
| `main.py` | ✅ | ❌ |
| `modules/**` | ✅ | ❌ |
| `public/**` | ❌ | ✅ |
| `firebase.json` | ❌ | ✅ |
| `README.md` | ❌ | ❌ |
| 백엔드+프론트엔드 동시 수정 | ✅ | ✅ |

## 🔍 테스트 방법

### 백엔드 테스트
```bash
# main.py 수정 후 커밋/푸시
git add main.py
git commit -m "Test: 백엔드 배포 테스트"
git push
```
→ "Deploy Backend to Cloud Run" 워크플로우만 실행

### 프론트엔드 테스트
```bash
# public/index.html 수정 후 커밋/푸시
git add public/
git commit -m "Test: 프론트엔드 배포 테스트"
git push
```
→ "Firebase Hosting Deploy" 워크플로우만 실행

### 통합 테스트
```bash
# 백엔드와 프론트엔드 파일 모두 수정 후 커밋/푸시
git add .
git commit -m "Test: 분리 배포 통합 테스트"
git push
```
→ 두 워크플로우 모두 실행

## ⚠️ 주의사항

1. **정적 파일 참조**: Cloud Run에서는 `public/` 폴더에 접근할 수 없으므로, 백엔드 코드에서 정적 파일을 직접 참조하면 안됩니다.

2. **CORS 설정**: 프론트엔드와 백엔드가 다른 도메인에서 실행되므로 CORS 설정이 중요합니다.

3. **API 경로**: Firebase Hosting의 rewrite 규칙에 따라 `/api/**` 경로만 백엔드로 라우팅됩니다.

4. **환경변수**: 로컬 개발시에는 `SERVE_STATIC=true`(기본값), 배포시에는 `SERVE_STATIC=false`로 설정됩니다.

## 🎉 예상 효과

### 장점
- **독립적 배포**: 백엔드와 프론트엔드를 각각 독립적으로 배포 가능
- **성능 최적화**: 정적 파일은 CDN(Firebase Hosting), API는 Cloud Run으로 최적화
- **비용 절약**: 정적 파일 서빙 비용 절약
- **확장성**: 각각 다른 스케일링 정책 적용 가능

### 개발 효율성
- **선택적 배포**: 변경된 부분만 배포되어 시간 단축
- **개발 환경 유지**: 로컬에서는 기존과 동일한 개발 경험
- **환경 분리**: staging과 production 환경 명확히 분리

## 🐛 추가 문제 해결 (오후 작업)

### Discovery Engine API 400 에러 해결

**문제**: 배포 후 API 호출 시 "Search API error 400" 발생
```json
{
  "answer": "죄송합니다. 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.",
  "metadata": {"engine_type": "error_fallback", "error": "Search API error 400"}
}
```

**원인 분석**:
- `config.py`에서 `DISCOVERY_ENGINE_ID` 환경변수를 참조
- `cloudbuild.yaml`에서는 `DATASTORE_ID`만 설정하고 `DISCOVERY_ENGINE_ID` 누락
- 결과적으로 Discovery Engine API 호출 시 잘못된 URL 생성

**해결 과정**:

1. **환경변수 추가**:
```yaml
# cloudbuild.yaml - substitutions 섹션에 추가
_DATASTORE_ID: test_1753406039510
_DISCOVERY_ENGINE_ID: test_1753406039510
_MODEL_ID: gemini-2.5-flash
_LOCATION_ID: us-central1
_DATASTORE_LOCATION: global
```

2. **하드코딩 제거 및 변수화**:
```yaml
# Before (하드코딩)
--set-env-vars=...,DATASTORE_ID=kbdcomparison_1753071399773,...

# After (변수 사용)
--set-env-vars=...,DATASTORE_ID=${_DATASTORE_ID},DISCOVERY_ENGINE_ID=${_DISCOVERY_ENGINE_ID},...
```

3. **불필요한 환경변수 정리**:
```yaml
# 삭제된 환경변수 (사용하지 않음)
SPANNER_INSTANCE_ID=cheomkdbspanner
SPANNER_DATABASE_ID=kdbspanner  
SPANNER_TABLE_NAME=Triple
```

**최종 환경변수 구성**:
```yaml
--set-env-vars=PROJECT_ID=${_PROJECT_ID},LOCATION_ID=${_LOCATION_ID},MODEL_ID=${_MODEL_ID},DATASTORE_ID=${_DATASTORE_ID},DATASTORE_LOCATION=${_DATASTORE_LOCATION},DISCOVERY_ENGINE_ID=${_DISCOVERY_ENGINE_ID},SYSTEM_PROMPT_PATH=prompt/prompt.txt,USE_SECRET_MANAGER=True,SERVE_STATIC=false
```

### 코드 품질 개선

**main.py 정리**:
- 주석 코드 제거
- import 순서 정리  
- 환경변수 처리 로직 개선

**index.html 업데이트**:
- 버전 표시: "v1.0" → "v1.1"
- 테스트 배포 확인용

## 📈 개선된 재사용성

### Before vs After 비교

**Before (하드코딩)**:
```yaml
--set-env-vars=DATASTORE_ID=kbdcomparison_1753071399773,DISCOVERY_ENGINE_ID=test_1753406039510
```

**After (변수화)**:
```yaml
substitutions:
  _DATASTORE_ID: test_1753406039510
  _DISCOVERY_ENGINE_ID: test_1753406039510

--set-env-vars=DATASTORE_ID=${_DATASTORE_ID},DISCOVERY_ENGINE_ID=${_DISCOVERY_ENGINE_ID}
```

### 다른 프로젝트 적용 방법

```yaml
# 새 프로젝트용 cloudbuild.yaml
substitutions:
  _PROJECT_ID: my-new-project
  _DATASTORE_ID: my-datastore-456
  _DISCOVERY_ENGINE_ID: my-engine-789
  # 나머지 설정은 그대로 유지
```

## 📝 향후 개선사항

1. **환경별 서비스명 분리**: 현재 staging/production 모두 같은 Cloud Run 서비스 사용
2. **보안 스캔 활성화**: 필요시 cloudbuild.yaml의 보안 스캔 단계 활성화
3. **모니터링 강화**: 각 환경별 모니터링 및 알림 설정
4. **성능 최적화**: 배포 속도 및 리소스 사용량 최적화
5. **서비스 계정 권한 점검**: Discovery Engine API 접근 권한 확인

## 🎯 검증 완료

- ✅ 백엔드 분리 배포 성공
- ✅ 프론트엔드 분리 배포 성공  
- ✅ Discovery Engine API 에러 해결
- ✅ 환경변수 구조 개선
- ✅ 재사용성 향상

---

**작업 완료일**: 2025-07-30  
**최종 업데이트**: 2025-07-30 오후  
**담당자**: Claude Code  
**상태**: 완료 및 검증됨 ✅