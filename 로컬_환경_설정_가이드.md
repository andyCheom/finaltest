# 📋 GraphRAG 로컬 환경 설정 가이드

GraphRAG 프로젝트를 로컬 환경에서 실행하기 위한 환경 설정 가이드입니다.

## 📦 시스템 요구사항

### 필수 소프트웨어
- **Python 3.11+** (Python 패키지 실행용)
- **pip** (Python 패키지 관리자)
- **Node.js 18+** (Firebase CLI 설치용)
- **npm** (Node.js 패키지 관리자)
- **Git** (코드 저장소 복제용)

### 선택사항
- **Docker** (컨테이너 환경 테스트용)
- **Google Cloud SDK (gcloud CLI)** (Cloud 서비스 관리용)

## 🛠️ 설치 단계

### 1. 프로젝트 복제 및 디렉토리 이동

```bash
git clone <REPOSITORY_URL>
cd graphrag
```

### 2. Python 가상환경 설정

```bash
# 가상환경 생성
python3 -m venv venv

# 가상환경 활성화
# Linux/macOS:
source venv/bin/activate

# Windows:
venv\Scripts\activate
```

### 3. Python 의존성 설치

```bash
# requirements.txt에 명시된 패키지 설치
pip install -r requirements.txt
```

#### 주요 Python 패키지
- **FastAPI**: 웹 API 프레임워크
- **Uvicorn/Gunicorn**: ASGI 서버
- **Google Cloud 라이브러리**: GCP 서비스 연동
  - `google-cloud-storage`
  - `google-cloud-spanner`
  - `google-auth`
  - `google-api-python-client`
- **기타 유틸리티**: 
  - `requests`, `aiohttp` (HTTP 클라이언트)
  - `python-dotenv` (환경변수 관리)
  - `python-multipart` (파일 업로드)
  - `soynlp` (한국어 처리)

### 4. Firebase CLI 설치 (선택사항)

```bash
# Firebase CLI 전역 설치
npm install -g firebase-tools

# Google 계정으로 로그인
firebase login
```

## 🔑 환경 변수 설정

### 필수 환경 변수

프로젝트 루트에 `.env` 파일을 생성하거나 시스템 환경 변수로 설정:

```bash
# Google Cloud 프로젝트 설정
PROJECT_ID=your-gcp-project-id
LOCATION_ID=us-central1
MODEL_ID=gemini-2.5-flash

# Vertex AI Search (Discovery Engine) 설정
DATASTORE_ID=your-datastore-id
DATASTORE_LOCATION=global

# Discovery Engine 세부 설정
DISCOVERY_LOCATION=global
DISCOVERY_COLLECTION=default_collection
DISCOVERY_ENGINE_ID=test_1753406039510
DISCOVERY_SERVING_CONFIG=default_search

# Spanner 데이터베이스 설정
SPANNER_INSTANCE_ID=your-spanner-instance
SPANNER_DATABASE_ID=your-spanner-database
SPANNER_TABLE_NAME=Triple

# 파일 경로 설정
SYSTEM_PROMPT_PATH=prompt/prompt.txt
SERVICE_ACCOUNT_PATH=keys/your-service-account-key.json
STOPWORDS_PATH=stopwords.txt

# 서버 설정
API_PORT=8000
STATIC_FILES_DIR=public

# CORS 설정 (쉼표로 구분된 도메인 목록, * = 모든 도메인)
CORS_ORIGINS=*

# OAuth 설정 (선택사항)
OAUTH_CLIENT_ID=your-oauth-client-id.googleusercontent.com
OAUTH_CLIENT_SECRET=your-oauth-client-secret
OAUTH_REDIRECT_URI=http://localhost:8080/oauth/callback

# 로깅 설정
LOG_LEVEL=INFO
LOG_DIR=logs

# HTTP 타임아웃 설정 (초)
HTTP_TIMEOUT_TOTAL=300
HTTP_TIMEOUT_CONNECT=10
HTTP_KEEPALIVE_TIMEOUT=30

# 서버 성능 설정
GUNICORN_WORKERS=4
CLOUD_RUN_CONCURRENCY=80

# 앱 정보
APP_NAME=GraphRAG Chatbot API
APP_VERSION=2.0.0
APP_DESCRIPTION=모듈화된 GraphRAG 기반 챗봇 API

# Secret Manager 사용 여부 (클라우드 배포시)
USE_SECRET_MANAGER=False
```

### 환경 변수 설정 방법

#### 옵션 1: .env 파일 사용
```bash
# 프로젝트 루트에 .env 파일 생성
touch .env
# 위의 환경 변수들을 .env 파일에 작성
```

#### 옵션 2: 시스템 환경 변수 설정
```bash
# Linux/macOS
export PROJECT_ID="your-gcp-project-id"
export LOCATION_ID="us-central1"
# ... 기타 변수들

# Windows (PowerShell)
$env:PROJECT_ID="your-gcp-project-id"
$env:LOCATION_ID="us-central1"
# ... 기타 변수들
```

## 🔐 Google Cloud 인증 설정

### 1. 서비스 계정 키 파일 준비

1. Google Cloud Console에서 서비스 계정 키 파일(JSON) 다운로드
2. 파일을 `keys/` 디렉토리에 배치
3. `modules/config.py`에서 `SERVICE_ACCOUNT_PATH` 경로 확인

```python
# config.py 예시
SERVICE_ACCOUNT_PATH = "keys/your-service-account-key.json"
```

### 2. 필요한 IAM 권한

서비스 계정에 다음 역할을 부여해야 합니다:

- `roles/aiplatform.user` (Vertex AI 사용)
- `roles/spanner.databaseUser` (Spanner 읽기)
- `roles/storage.objectViewer` (Cloud Storage 접근)
- `roles/discoveryengine.admin` (Discovery Engine 사용)

### 3. 로컬 개발용 인증 (대안)

```bash
# Google Cloud SDK 설치 후
gcloud auth application-default login
```

## 📁 필수 파일 및 디렉토리 구조

```
graphrag/
├── keys/                    # 🔑 서비스 계정 키 파일
│   └── your-key.json       # Google Cloud 인증용
├── prompt/                 # 💬 AI 프롬프트 파일
│   └── prompt.txt         # 시스템 프롬프트
├── stopwords.txt          # 🚫 불용어 사전
├── modules/               # 📦 소스 코드 모듈
├── public/                # 🌐 정적 웹 파일
├── .env                   # ⚙️ 환경 변수 (생성 필요)
├── requirements.txt       # 📋 Python 의존성
└── main.py               # 🚀 애플리케이션 진입점
```

## 🚀 애플리케이션 실행

### 개발 서버 실행

```bash
# FastAPI 개발 서버 실행 (핫 리로드 활성화)
uvicorn main:app --reload --port 8000

# 또는 Python으로 직접 실행
python main.py
```

### 프로덕션 서버 실행

```bash
# Gunicorn + Uvicorn worker 조합
gunicorn -w 4 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 main:app
```

## 🌐 접속 확인

서버 실행 후 브라우저에서 확인:

- **애플리케이션**: http://localhost:8000
- **API 문서**: http://localhost:8000/docs (Swagger UI)
- **헬스 체크**: http://localhost:8000/api/health

## 🐳 Docker로 실행 (선택사항)

### Docker 이미지 빌드 및 실행

```bash
# Docker 이미지 빌드
docker build -t graphrag-app .

# 컨테이너 실행 (환경 변수 주입)
docker run -p 8000:8080 \
  -e PROJECT_ID=your-project \
  -e LOCATION_ID=us-central1 \
  -e MODEL_ID=gemini-2.5-flash \
  -e DATASTORE_ID=your-datastore \
  -e DATASTORE_LOCATION=global \
  -v $(pwd)/keys:/usr/src/app/keys:ro \
  graphrag-app
```

## ⚠️ 문제 해결

### 일반적인 오류 및 해결책

#### 1. 인증 오류
```
❌ 인증 초기화 실패 - 서비스가 제대로 작동하지 않을 수 있습니다.
```
**해결책**: 
- 서비스 계정 키 파일 경로 확인
- IAM 권한 확인
- `gcloud auth application-default login` 실행

#### 2. 환경 변수 오류
```
❌ 환경변수 'PROJECT_ID'가 설정되어 있지 않습니다.
```
**해결책**: 
- `.env` 파일 생성 및 환경 변수 설정
- 시스템 환경 변수 확인

#### 3. 의존성 설치 오류
```
ERROR: Could not find a version that satisfies the requirement...
```
**해결책**: 
- Python 버전 확인 (3.11+ 필요)
- pip 업그레이드: `pip install --upgrade pip`
- 가상환경 재생성

#### 4. 포트 충돌
```
OSError: [Errno 98] Address already in use
```
**해결책**: 
- 다른 포트 사용: `uvicorn main:app --port 8001`
- 기존 프로세스 종료: `lsof -ti:8000 | xargs kill -9`

### 로그 확인

```bash
# 애플리케이션 로그 확인
tail -f logs/*.json

# 또는 실시간 로그 출력으로 실행
uvicorn main:app --reload --log-level debug
```

## 📚 추가 리소스

- [FastAPI 공식 문서](https://fastapi.tiangolo.com/)
- [Google Cloud Vertex AI 문서](https://cloud.google.com/vertex-ai/docs)
- [Google Cloud Spanner 문서](https://cloud.google.com/spanner/docs)
- [Firebase Hosting 문서](https://firebase.google.com/docs/hosting)

---

**참고**: 이 가이드는 로컬 개발 환경 기준으로 작성되었습니다. 프로덕션 배포는 `cloudbuild.yaml` 및 `Dockerfile`을 참조하세요.